name: PR Quality Check

on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - '**.rs'
      - '**.vue'
      - 'package.json'
      - 'src-tauri/Cargo.toml'
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'src/i18n/locales/**.ts'
      - '.github/workflows/**'

jobs:
  check:
    name: Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libxss-dev

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Format Check
        run: |
          echo "ðŸ” Checking code formatting..."
          bunx biome check .
          cargo fmt --manifest-path src-tauri/Cargo.toml --all --check

      - name: Lint Check
        run: |
          echo "ðŸ” Running linters..."
          cargo clippy --manifest-path src-tauri/Cargo.toml --workspace --all-targets -- -D warnings

      - name: Type Check
        run: |
          echo "ðŸ” Running type checks..."
          bunx tsc --noEmit
          cargo check --manifest-path src-tauri/Cargo.toml --workspace --all-targets

      - name: Run Tests
        run: |
          echo "ðŸ§ª Running tests..."
          bun run test:run
          cargo test --manifest-path src-tauri/Cargo.toml --workspace

      - name: Quality Check Summary
        if: always()
        run: |
          echo "## Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks completed!" >> $GITHUB_STEP_SUMMARY
